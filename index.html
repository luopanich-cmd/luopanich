<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Stock Viewer</title>

<!-- ================= UI STYLE ================= -->
<style>
  html, body {
  margin: 0;
  padding: 0;

  width: 100%;
  max-width: 100%;
  overflow-x: hidden;   /* üî¥ ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏´‡∏±‡∏ß‡πÉ‡∏à */

  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
}
  header{
  padding:16px;
  font-size:22px;
  font-weight:500;

  /* üîπ Visual */
  background:rgba(255,255,255,.85);
  backdrop-filter:blur(12px);

  /* üîπ Position */
  position:sticky;
  top:0;
  z-index:10;

  /* üîπ Layout (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) */
  display:flex;
  justify-content:space-between;
  align-items:center;

  /* üî¥ FIX ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç */
  min-height:56px;      /* ‡∏Å‡∏±‡∏ô iOS / mobile ‡πÑ‡∏°‡πà render ‡∏õ‡∏∏‡πà‡∏° */
  box-sizing:border-box;
}

  .badge{
    background:#ff3b30;color:#fff;
    border-radius:12px;padding:2px 8px;
    font-size:12px;
  }
  .container{padding:16px;display:grid;gap:16px;}
  .card{
    background:#fff;border-radius:18px;
    box-shadow:0 8px 24px rgba(0,0,0,.06);
    padding:14px;cursor:pointer;
  }
  .name{font-weight:600;}
  .price{color:#007aff;margin-top:4px;}
  .stock{font-size:14px;color:#666;}

  .backdrop{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.25);
  backdrop-filter: blur(2px);
  display: none;
  z-index: 100;
}

.sheet{
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;

  background: #fff;
  border-radius: 22px 22px 0 0;

  padding: 20px 20px env(safe-area-inset-bottom);

  /* ‚úÖ CORE FIX */
  max-height: calc(100dvh - 40px);   /* ‡πÉ‡∏ä‡πâ dvh ‡πÅ‡∏ó‡∏ô vh */
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;

  transform: translateY(100%);
  transition: transform .3s ease;

  z-index: 101;
}

.sheet.show{
  transform: translateY(0);
}

.sheet h3{
  margin:0 0 12px;
}



/* ================= BASE INPUT (NEUTRAL) ================= */
input,
select {
  width: 100%;
  box-sizing: border-box;
  outline: none;
  font-family: inherit;
  background: #fff;
}

input:focus,
select:focus {
  border-color: #007aff;
}

/* ================= STEP 3: FORM CONSISTENT ================= */

.form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 14px;
}

.form-group label {
  font-size: 13px;
  color: #666;
}

/* ================= FORM INPUT (UNIFIED) ================= */

/* ‡∏ó‡∏∏‡∏Å input / select ‡πÉ‡∏ô form + ‡∏Å‡∏±‡∏ô iOS zoom */
.form-group input,
.form-group select {
  width: 100%;
  height: 44px;
  padding: 10px 12px;

  font-size: 16px;          /* üî¥ FIX iOS ZOOM */
  line-height: 1.2;

  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
  background: #fff;
  font-family: inherit;
}

/* number ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô text (iOS / Android) */
.form-group input[type="number"] {
  appearance: textfield;
  -moz-appearance: textfield;
}

/* focus state */
.form-group input:focus,
.form-group select:focus {
  border-color: #007aff;
  outline: none;
}

  

  .btn{
    padding:12px;border:none;border-radius:12px;
    font-weight:600;
  }

  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
  .btn-primary{background:#007aff;color:#fff;}
  .btn-secondary{background:#34c759;color:#fff;}
  .btn-remove{
  width:32px;
  height:32px;
  border-radius:50%;
  background:#ff3b30;
  color:#fff;
  border:none;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:600;
  line-height:1;
  cursor:pointer;
  }
  /* ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ */
.btn-remove:active {
  transform: scale(0.95);
}

/* üî¥ DANGER / DELETE / EXIT */
.btn-danger {
  background: #ff3b30;
  color: #fff;
}

/* ‚ö™ OUTLINE / CANCEL */
.btn-outline {
  background: #f2f2f7;
  color: #333;
  border: 1px solid #ddd;
}

/* interaction */
.btn-danger:active,
.btn-outline:active {
  transform: scale(0.97);
}
  
/* ================= BUTTON SYSTEM ================= */

.btn {
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-weight: 600;
  font-size: 15px;
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

/* Primary */
.btn-primary {
  background: #007aff;
  color: #fff;
}

/* Secondary (soft green) */
.btn-secondary {
  background: #34c759;
  color: #fff;
}

/* Danger (soft red) */
.btn-danger {
  background: #ff3b30;
  color: #fff;
}

/* Outline (cancel / back) */
.btn-outline {
  background: #f2f2f7;
  color: #333;
  border: 1px solid #ddd;
}

/* Interaction */
.btn:active {
  transform: scale(0.97);
}

  .cart-item{
    display:flex;justify-content:space-between;
    align-items:center;margin-bottom:12px;
  }
  .total{
    font-size:18px;font-weight:700;
    text-align:right;margin-top:12px;
  }

  /* ===== Order Preview (Hidden) ===== */
  #orderPreview {
    width: 360px;
    padding: 16px;
    background: #fff;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    display: none;
  }
  #orderPreview h2 {
    margin: 0 0 8px;
  }
  #orderPreview .item {
    display:flex;
    justify-content:space-between;
    margin-bottom:6px;
    font-size:14px;
  }
  #orderPreview .footer {
    margin-top:12px;
    font-weight:700;
    text-align:right;
  }

  /* ================= HEADER SEARCH ================= */
.header-search {
  width: 100%;
  height: 40px;
  padding: 8px 12px;
  margin-top: 6px;

  font-size: 16px;
  border-radius: 12px;
  border: 1px solid #ddd;
  box-sizing: border-box;
}


  /* ================= PRODUCT CARD (HORIZONTAL) ================= */
.product-card {
  display: flex;
  gap: 12px;
  background: #fff;
  border-radius: 16px;
  padding: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,.06);
  align-items: center;
  cursor: pointer;
}

.product-card .thumb {
  width: 80px;
  height: 80px;
  border-radius: 12px;
  object-fit: cover;
  background: #f0f0f0;
  flex-shrink: 0;
}

.product-card .info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.product-card .name {
  font-weight: 600;
  font-size: 16px;
}

.product-card .sku {
  font-size: 12px;
  color: #888;
}

.product-card .price {
  color: #007aff;
  font-weight: 600;
  margin-top: 2px;
}

.product-card .meta {
  display: flex;
  gap: 10px;
  align-items: center;
  font-size: 13px;
  color: #555;
}

/* ===== Status Badge ===== */
.status {
  padding: 2px 8px;
  border-radius: 999px; 
  font-size: 12px;
  font-weight: 500;
}

.status.ready {
  background: #e6f9f0;
  color: #1e9c6a;
}

.status.out {
  background: #fdecec;
  color: #d93025;
}

.status.warehouse {
  background: #eef3ff;
  color: #3b6cff;
}

.admin-action {
  display: flex;
  gap: 12px;
  margin-top: 16px;
}

.btn-approve {
  flex: 1;
  background: #007aff;
  color: #fff;
}

.btn-reject {
  flex: 1;
  background: #ff3b30;
  color: #fff;
}

.btn-approve:active,
.btn-reject:active {
  transform: scale(0.97);
}

/* ================= SIDE ADMIN MENU ================= */
.side-menu {
  position: fixed;
  top: 0;
  right: 0;

  width: min(65vw, 260px);
   /* ‚úÖ ‡∏•‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≠‡∏î‡∏µ */
  height: 100vh;

  background: #ffffff;
  box-shadow: -6px 0 20px rgba(0,0,0,.12);

  z-index: 102;
  padding: 16px;            /* ‚úÖ ‡∏•‡∏î padding ‡πÉ‡∏´‡πâ‡∏î‡∏π‡πÑ‡∏°‡πà‡∏≠‡∏∂‡∏î‡∏≠‡∏±‡∏î */

  transform: translateX(100%);
  transition: transform .28s ease;
  will-change: transform;
}

.side-menu.show {
  transform: translateX(0);
}

/* ===== UI DETAILS ===== */
.side-menu h3 {
  margin-top: 0;
  margin-bottom: 16px;
}

.side-menu .menu-btn {
  width: 100%;
  margin-bottom: 12px;
}

.loading {
  text-align: center;
  padding: 32px 16px;
  color: #666;
  font-size: 14px;
}

.loading::after {
  content: "‚Ä¶";
  animation: dots 1.4s infinite;
}

@keyframes dots {
  0%   { content: ""; }
  33%  { content: "."; }
  66%  { content: ".."; }
  100% { content: "..."; }
}

.menu-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.menu-group.danger {
  margin-top: 12px;
}

.btn-danger {
  background: #ff3b30;
  color: #fff;
}

.btn-danger:active {
  transform: scale(0.97);
}

/* üîí iOS SAFARI ZOOM FIX */
input,
select,
textarea {
  font-size: 16px !important; /* üî¥ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î */
} 

/* ===== STOCK TIMELINE COLOR TAG ===== */
.timeline-tag {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 6px;
}

/* ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó */
.tag-in {
  background: #e6f9f0;
  color: #1e9c6a;
}

.tag-out {
  background: #fdecec;
  color: #d93025;
}

.tag-create {
  background: #eef3ff;
  color: #3b6cff;
}

.tag-adjust {
  background: #fff4e5;
  color: #e37400;
}

.tag-cancel {
  background: #f1f1f1;
  color: #666;
}

/* ===== ADMIN LOGIN TWEAK ===== */
#adminLoginSheet {
  padding-bottom: calc(env(safe-area-inset-bottom) + 24px); /* üî¥ ‡∏¢‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö */
}

/* ===== PREMIUM INPUT STYLE ===== */
.form-group input,
#adminLoginSheet input {
  background: #f9f9fb;
  border: 1px solid #e5e5ea;
  box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
}

.form-group input:focus,
#adminLoginSheet input:focus {
  background: #fff;
  border-color: #007aff;
  box-shadow:
    0 0 0 2px rgba(0,122,255,.15),
    inset 0 1px 2px rgba(0,0,0,.04);
} 

/* ================= TOAST SYSTEM (GLOBAL FEEDBACK) ================= */

#toast-container {
  position: fixed;
  top: env(safe-area-inset-top, 12px);
  left: 50%;
  transform: translateX(-50%);
  z-index: 3000;

  display: flex;
  flex-direction: column;
  gap: 8px;

  pointer-events: none; /* üîí ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á interaction */
}

.toast {
  min-width: 260px;
  max-width: 90vw;
  padding: 12px 16px;

  border-radius: 14px;
  color: #fff;
  font-size: 14px;
  font-weight: 500;

  box-shadow: 0 8px 24px rgba(0,0,0,.18);

  animation: toast-slide-down .25s ease;
}

/* ===== Toast Variants ===== */
.toast.success { background: #34c759; }
.toast.error   { background: #ff3b30; }
.toast.warning { background: #ff9f0a; }
.toast.info    { background: #007aff; }

/* ===== Animation (namespaced) ===== */
@keyframes toast-slide-down {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.hidden {
  display: none;
}

#loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#loading-overlay.hidden {
  display: none !important;
}

.loading-box {
  background: #fff;
  padding: 20px 24px;
  border-radius: 12px;
  text-align: center;
  min-width: 200px;
}

.spinner {
  width: 32px;
  height: 32px;
  border: 3px solid #ddd;
  border-top-color: #555;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 12px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
  
</style>
</head>
<body>

<!-- üî¥ HEADER (Mode-Based Controlled) -->
<header id="appHeader"></header>


<div id="app" class="container"></div>

<!-- ‚úÖ GLOBAL BACKDROP (‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠) -->
<div id="globalBackdrop" class="backdrop" onclick="handleBackdropClick()"></div>

<!-- ================= VIEWER SHEETS ================= -->
<div id="productSheet" class="sheet"></div>
<div id="qtySheet" class="sheet"></div>
<div id="cartSheet" class="sheet"></div>
<div id="confirmSheet" class="sheet"></div>
<div id="stockSheet" class="sheet"></div>  

<!-- ================= ADMIN SHEETS ================= -->
<div id="adminLoginSheet" class="sheet"></div>
<div id="adminDashboardSheet" class="sheet"></div>
<div id="adminOrderSheet" class="sheet"></div>
<div id="adminStockSheet" class="sheet"></div>

<!-- üîπ Admin Side Menu -->
<div id="adminMenuSheet" class="side-menu"></div>

<!-- üîπ Admin Product -->
<div id="adminProductActionSheet" class="sheet"></div>
<div id="adminProductEditSheet" class="sheet"></div>

<!-- üîπ Stock (STEP 7.5) -->
<div id="adminStockActionSheet" class="sheet"></div>

<!-- üîπ ADD PRODUCT (STEP 7.6) ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà -->
<div id="adminAddProductSheet" class="sheet"></div>

  
<script>
/* ================= STEP 2: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® backdrop (UPGRADED) ================= */
const backdrop = document.getElementById("globalBackdrop");

// üîí ‡πÉ‡∏ä‡πâ state.ui.backdropLocked ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (single source of truth)
let allowOpenOrders = false;

  
/* ================= GLOBAL STATE (UPGRADED / SAFE) ================= */

const state = {
  mode: "viewer",
  search: "",
  products: [],
  selectedProduct: null,
  qty: 1,
  cart: [],
  lastOrder: null,

  // üîí viewer submit guard (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö createOrder)
  isSubmitting: false,

  admin: {
    loggedIn: false,
    user: null,
    token: null,          // ‚úÖ ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ö‡∏≤‡∏á‡∏à‡∏∏‡∏î‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß / future-proof
    orders: [],
    selectedOrder: null,
    logs: [],

    // üîí admin submit guard (approve / reject / stock)
    isSubmitting: false
  },

  ui: {
    overlayCount: 0,

    // üîí ‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö loading / overlay
    backdropLocked: false
  }
};

  /* ===== Feedback & Loading Utilities ===== */

function showToast(message, type = 'info', timeout = 2500) {
  const container = document.getElementById('toast-container');
  if (!container) return;

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;

  container.appendChild(toast);

  // üîí limit toast count (optional but pro)
  if (container.children.length > 3) {
    container.removeChild(container.firstChild);
  }

  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, timeout);
}

// ---------- Central loading timer ----------
let _loadingTimer = null;
let _loadingShownAt = 0;
const MIN_LOADING_MS = 350; // ‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö

function showLoading(message, timeoutMs = 60000) {
  const overlay = document.getElementById("loading-overlay");
  const text = document.getElementById("loading-text");
  if (!overlay || !text) return;

  text.textContent = message;
  overlay.classList.remove("hidden");

  // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö render
  overlay.offsetHeight;

  _loadingShownAt = Date.now();

  state.isSubmitting = true;
  state.ui.backdropLocked = true;
  if (backdrop) backdrop.style.display = "block";

  clearTimeout(_loadingTimer);
  _loadingTimer = setTimeout(() => {
    console.warn("[showLoading] auto-hide after timeout");
    safeHideLoading(true);
    showToast("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß", "warning", 1800);
  }, timeoutMs);
}

function safeHideLoading(fromTimeout = false) {
  const overlay = document.getElementById("loading-overlay");

  const elapsed = Date.now() - _loadingShownAt;
  const delay = Math.max(0, MIN_LOADING_MS - elapsed);

  setTimeout(() => {
    if (overlay) overlay.classList.add("hidden");

    clearTimeout(_loadingTimer);
    _loadingTimer = null;

    state.isSubmitting = false;
    state.ui.backdropLocked = false;
    if (backdrop) backdrop.style.display = "none";

    console.log(
      "[safeHideLoading] loading closed",
      fromTimeout ? "(timeout)" : ""
    );
  }, delay);
}

// ---------- fetchWithTimeout ----------
async function fetchWithTimeout(input, init = {}, ms = 15000) {
  const controller = new AbortController();
  const signal = controller.signal;
  const id = setTimeout(() => controller.abort(), ms);

  try {
    const res = await fetch(input, { ...init, signal });
    return res;
  } finally {
    clearTimeout(id);
  }
}
  

/* ================= API LAYER ================= */
const API_URL="https://script.google.com/macros/s/AKfycbxU-C4aaBNkX_Ggz9txAdGLusXQZu07T24MPs_5QknESvMZrDckCQ9-n_RMQwVn1e_9/exec";

const fetchProducts = async () => {
  const res = await fetch(`${API_URL}?action=products`);
  const json = await res.json();

  // üîí enforce standard response
  if (!json || json.success !== true || !Array.isArray(json.data)) {
    console.error("fetchProducts invalid response:", json);
    return []; // ‚úÖ ‡∏Ñ‡∏∑‡∏ô array ‡πÄ‡∏™‡∏°‡∏≠
  }

  return json.data;
};

function sortProducts(products) {
  if (!Array.isArray(products)) return [];

  return products.sort((a, b) =>
    String(a.productId || "").localeCompare(
      String(b.productId || ""),
      'th',
      {
        numeric: true,
        sensitivity: 'base'
      }
    )
  );
}
  
async function refreshProducts() {
  const list = await fetchProducts();

  state.products = sortProducts(list); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  renderProducts();
}

async function createOrder() {
  const total = state.cart.reduce((s,i)=>s+i.price*i.qty,0);

  const form = new URLSearchParams();
  form.append("action", "createOrder");
  form.append("items", JSON.stringify(state.cart));
  form.append("total", total);

  // ‡πÉ‡∏ä‡πâ fetchWithTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô request ‡πÅ‡∏Ç‡∏ß‡∏ô
  const res = await fetchWithTimeout(API_URL, {
    method: "POST",
    body: form
  }, 15000); // 15s timeout

  return await res.json();
}

function openOverlay(el){
  if (!el || el.classList.contains("show")) return;

  el.classList.add("show");
  state.ui.overlayCount++;

  backdrop.style.display = "block";
}

function closeOverlay(el){
  if (!el || !el.classList.contains("show")) return;

  el.classList.remove("show");
  state.ui.overlayCount = Math.max(0, state.ui.overlayCount - 1);

  if (state.ui.overlayCount === 0 && !state.ui.backdropLocked) {
    backdrop.style.display = "none";
  }
}

async function adminStockIn(productId, qty, reason){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockIn");
  form.append("productId", productId);
  form.append("qty", qty);
  form.append("reason", reason || "");
  form.append("token", state.admin.token); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  // üîí session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / token ‡∏ú‡∏¥‡∏î
  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }
    throw new Error(json.error || "Stock IN failed");
  }

  return json;
}


async function adminStockAdjust(productId, newQty, reason){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockAdjust");
  form.append("productId", productId);
  form.append("newQty", newQty);
  form.append("reason", reason || "");
  form.append("token", state.admin.token); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  // üîí session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / token ‡∏ú‡∏¥‡∏î
  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }
    throw new Error(json.error || "Stock adjust failed");
  }

  return json;
}

  

/* ================= ADMIN API ================= */ // üî¥ ADD

async function adminApproveOrder(orderId) {
  if (state.admin.isSubmitting) return;
  state.admin.isSubmitting = true;

  try {
    if (!state.admin.token) {
      throw new Error("Not authenticated");
    }

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...");

    const form = new URLSearchParams();
    form.append("action", "approveOrder");
    form.append("orderId", orderId);
    form.append("token", state.admin.token);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (json.error || json.success === false) {
      if (
        json.error === "Session expired" ||
        json.error === "Invalid token" ||
        json.error === "Missing token"
      ) {
        showToast("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
        exitAdmin();
      }
      throw new Error(json.error || "Approve order failed");
    }

    // ‚úÖ success
    showToast("‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "success");
    return json.data;

  } catch (err) {
    console.error(err);
    showToast(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ", "error");
    throw err;
  } finally {
  safeHideLoading();
  state.admin.isSubmitting = false;
 }
}

async function adminRejectOrder(orderId) {
  if (state.admin.isSubmitting) return;
  state.admin.isSubmitting = true;

  try {
    if (!state.admin.token) {
      throw new Error("Not authenticated");
    }

    showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...");

    const form = new URLSearchParams();
    form.append("action", "rejectOrder");
    form.append("orderId", orderId);
    form.append("token", state.admin.token);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (json.error || json.success === false) {
      if (
        json.error === "Session expired" ||
        json.error === "Invalid token" ||
        json.error === "Missing token"
      ) {
        showToast("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà", "warning");
        exitAdmin();
      }
      throw new Error(json.error || "Reject order failed");
    }

    // ‚úÖ success
    showToast("‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "success");
    return json.data;

  } catch (err) {
    console.error(err);
    showToast(
      err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏î‡πâ",
      "error"
    );
    throw err;

  } finally {
    // ‚úÖ cleanup ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    safeHideLoading();
    state.admin.isSubmitting = false;
  }
}

async function fetchStockLogs() {
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "stockLogs");
  form.append("token", state.admin.token);

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  if (json.error || json.success === false) {
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token" ||
      json.error === "Missing token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
    }

    throw new Error(json.error || "‡πÇ‡∏´‡∏•‡∏î Stock Logs ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  return json;
}


  

async function fetchOrders(){
  if (!state.admin.token) {
    throw new Error("Not authenticated");
  }

  const form = new URLSearchParams();
  form.append("action", "orders");
  form.append("token", state.admin.token);

  const res = await fetch(API_URL, {
    method: "POST",
    body: form
  });

  const json = await res.json();

  if (!json.success) {
    // üîí token ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ / ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    if (
      json.error === "Session expired" ||
      json.error === "Invalid token"
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin(); // logout ‡∏ù‡∏±‡πà‡∏á frontend
    }
    throw new Error(json.error || "‡πÇ‡∏´‡∏•‡∏î Orders ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }

  // ‚úÖ ‡∏Ñ‡∏∑‡∏ô array ‡∏Ç‡∏≠‡∏á orders
  return json.data;
}
  
/* ================= STOCK CHECK ================= */
async function checkStockBeforeSubmit() {
  const latestProducts = await fetchProducts();

  for (const item of state.cart) {
    const product = latestProducts.find(
      p => p.productId === item.productId
    );

    if (!product) {
      return { ok:false, message:`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${item.name}` };
    }

    if (Number(product.stock) < Number(item.qty)) {
      return {
        ok:false,
        message:`${item.name} ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${item.qty})`
      };
    }
  }

  return { ok:true };
}


/* ================= RENDER FUNCTIONS ================= */
function renderProducts(){
  // üîí GUARD ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  if (!Array.isArray(state.products)) {
    console.error("renderProducts: products is not array", state.products);
    app.innerHTML = `
      <div style="
        text-align:center;
        color:#d93025;
        margin-top:40px;
        font-size:15px;
      ">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ
      </div>
    `;
    return;
  }

  app.innerHTML = "";
  let found = false;

  state.products.forEach(p => {

    // ‚ùå ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢ (viewer ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
    if (state.mode === "viewer" && !p.active) return;

    // üîç SEARCH FILTER (‡∏ä‡∏∑‡πà‡∏≠ + ‡∏£‡∏´‡∏±‡∏™)
    if (state.search) {
      const text = (p.name + p.productId).toLowerCase();
      if (!text.includes(state.search)) return;
    }

    found = true;

    /* ================= STATUS LOGIC ================= */
    let statusClass = "ready";
    let statusText  = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á ¬∑ ‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢";

    if (Number(p.stock) <= 0) {
      statusClass = "out";
      statusText  = "‡∏´‡∏°‡∏î";
    }

    /* ================= CARD ================= */
    const card = document.createElement("div");
    card.className = "product-card";

    card.onclick = () => {
      if (state.mode === "admin") {
        openAdminProductAction(p);
      } else {
        openProduct(p);
      }
    };

    card.innerHTML = `
      <img class="thumb"
        src="${p.image || ""}"
        alt="${p.name}"
        onerror="this.style.display='none'">

      <div class="info">
        <div class="name">${p.name}</div>
        <div class="sku">‡∏£‡∏´‡∏±‡∏™: ${p.productId}</div>
        <div class="price">‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${Number(p.price).toLocaleString()}</div>

        <div class="meta">
          <span class="qty">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${p.stock}</span>
          <span class="status ${statusClass}">
            ${statusText}
          </span>
        </div>
      </div>
    `;

    app.appendChild(card);
  });

  // ‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (!found) {
    app.innerHTML = `
      <div style="
        text-align:center;
        color:#888;
        margin-top:40px;
        font-size:15px;
      ">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      </div>
    `;
  }
}



function renderProductSheet(){
  const p = state.selectedProduct;

  productSheet.innerHTML = `
    <h3>${p.name}</h3>
    <div style="color:#888;font-size:13px">
      ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.productId}
    </div>

    <!-- ‚úÖ FIX IMAGE -->
    <img 
      src="${p.image || ''}"
      style="
        width:100%;
        max-height:280px;
        object-fit:cover;
        border-radius:14px;
        margin:12px 0;
        background:#f0f0f0;
      "
    >

    <div class="price">‡∏ø${p.price}</div>
    <div class="stock">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</div>

    ${
      state.mode === "viewer"
        ? `
          <button class="btn btn-primary"
            style="width:100%;margin-top:16px"
            onclick="openQtySheet()">
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          </button>
        `
        : `
          <div style="margin-top:16px;color:#888;font-size:14px">
            üîß ‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
          </div>
        `
    }
  `;
}



function renderCart(){
  cartSheet.innerHTML="<h3>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</h3>";

  if(state.cart.length===0){
    cartSheet.innerHTML+=`<div style="color:#888">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>
`;
    return;
  }

  state.cart.forEach((i,idx)=>{
  cartSheet.innerHTML+=`
    <div class="cart-item">
      <div>
        <div class="name">${i.name}</div>
        <div style="font-size:12px;color:#888">
          ‡∏£‡∏´‡∏±‡∏™: ${i.productId}
        </div>
        <div class="price">‡∏ø${i.price}</div>
      </div>
            <div>
        <div style="font-size:14px;color:#555">
  ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${i.qty || 1}
</div>
        <button class="btn-remove"
          onclick="removeItem(${idx})">√ó</button>
      </div>
    </div>`;
  });

  const total=state.cart.reduce((s,i)=>s+i.price*i.qty,0);
  cartSheet.innerHTML+=`
      <div class="total">Total: ‡∏ø${total}</div>
    <button class="btn btn-primary" style="width:100%;margin-top:12px"
      onclick="openConfirm()">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</button>`;
}

function renderBadge(){
  const cartButton = document.getElementById("cartButton");
  const cartBadge  = document.getElementById("cartBadge");

  if (!cartButton || !cartBadge) return;

  const count = state.cart.length;

  if (count > 0) {
    cartButton.style.display = "block";
    cartBadge.textContent = count;
  } else {
    cartButton.style.display = "none";
  }
}
  
function renderConfirmSheet(){
  let total = 0;

  confirmSheet.innerHTML = "<h3>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>";

  state.cart.forEach(i=>{
    const sum = i.price * i.qty;
    total += sum;

    confirmSheet.innerHTML += `
      <div class="cart-item">
        <div>
          <div class="name">${i.name}</div>
          <div style="font-size:12px;color:#888">‡∏£‡∏´‡∏±‡∏™: ${i.productId}</div>
          <div style="font-size:13px">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${i.qty}</div>
        </div>
        <div>‡∏ø${sum}</div>
      </div>
    `;
  });

  confirmSheet.innerHTML += `
    <div class="total">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total}</div>

    <button class="btn btn-primary"
      id="submitBtn"
      ${state.isSubmitting ? "disabled" : ""}
      onclick="submitOrder()">
      ${state.isSubmitting ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠..." : "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"}
    </button>
  `;
}

/* ================= HEADER RENDER (UPGRADED) ================= */
function renderHeader(){
  const h = document.getElementById("appHeader");
  if(!h) return;

  if(state.mode === "viewer"){
    h.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>

        <!-- üîç SEARCH -->
        <input
  class="header-search"
  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™"
  oninput="handleSearch(this.value)"
  onfocus="focusInput(this)"
>
      </div>

      <div style="
        display:flex;
        align-items:center;
        gap:14px;
        margin-left:12px;
      ">
        <div id="cartButton"
             onclick="openCart()"
             style="
               cursor:pointer;
               display:none;
               font-size:20px;
             ">
          üõí <span id="cartBadge" class="badge">0</span>
        </div>

        <button
          onclick="openAdminEntry()"
          style="
            width:40px;
            height:40px;
            border:none;
            background:none;
            font-size:26px;
            cursor:pointer;
          ">
          ‚ò∞
        </button>
      </div>
    `;
  }

  if(state.mode === "admin"){
    h.innerHTML = `
      <div style="flex:1">
        <div style="font-weight:600">Admin Panel</div>
        <div style="font-size:12px;color:#ff3b30">
          üõ† ADMIN MODE
        </div>

        <!-- üîç SEARCH -->
        <input
  class="header-search"
  placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏£‡∏´‡∏±‡∏™"
  oninput="handleSearch(this.value)"
  onfocus="focusInput(this)"
>
      </div>

      <button
        onclick="openAdminMenu()"
        style="
          width:40px;
          height:40px;
          border:none;
          background:none;
          font-size:26px;
          cursor:pointer;
          margin-left:12px;
        ">
        ‚ò∞
      </button>
    `;
  }
}

function handleSearch(keyword){
  state.search = keyword.toLowerCase();
  renderProducts();
}



function openAdminEntry(){
  // üîí ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ session ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏Ç‡πâ‡∏≤ admin ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (state.admin.loggedIn && state.admin.token) {
    enterAdmin();
    return;
  }

  // üîì ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà login ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤ login
  renderAdminLogin();
}


function enterAdmin(){
  state.mode = "admin";
  state.search = ""; // ‚úÖ reset
  renderHeader();
  renderProducts();
}

function exitAdmin(){
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î)
  document
    .querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el); // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à
    });

  // ‚ùå ‡∏Å‡∏±‡∏ô Orders ‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥
  allowOpenOrders = false;

  // üßπ CLEAR PERSIST SESSION  ‚Üê üî¥ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  clearAdminSession();

  // üîÑ reset admin state
  state.mode = "viewer";
  state.admin.loggedIn = false;
  state.admin.user = null;
  state.admin.token = null;
  state.admin.orders = [];
  state.admin.selectedOrder = null;
  state.admin.logs = [];

  // üîç reset search
  state.search = "";

  // üîÑ render viewer ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö clean
  renderHeader();
  renderProducts();
  renderBadge();
}

function handleBackdropClick(){
  if (state.ui.backdropLocked) {

    console.warn('[Backdrop] force unlock');

    safeHideLoading();   // ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏≤‡∏á error
    showToast("‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£", "warning", 1200);
    return;
  }

  closeTopSheet();
}

function closeTopSheet(){
  const sheets = [
    // üî¥ ADMIN FLOW (top ‚Üí bottom)
    adminMenuSheet,           // side menu
    adminProductActionSheet,
    adminProductEditSheet,
    adminStockActionSheet,
    adminOrderSheet,
    adminDashboardSheet,
    adminStockSheet,

    // üîµ VIEWER FLOW
    confirmSheet,
    cartSheet,
    qtySheet,
    productSheet,
    stockSheet
  ];

  for (const sheet of sheets) {
    if (sheet && sheet.classList.contains("show")) {
      // ‚úÖ ‡πÉ‡∏ä‡πâ Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
      closeOverlay(sheet);
      break;
    }
  }
}
 

function showStockError(message){
  stockSheet.innerHTML = `
    <h3 style="color:#ff3b30">‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</h3>

    <div style="
      font-size:15px;
      color:#333;
      line-height:1.5;
      margin-top:8px
    ">
      ${message}
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="closeStockError()">
      ‡∏ï‡∏Å‡∏•‡∏á
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(stockSheet);
}


function closeStockError(){
  closeOverlay(stockSheet);
  openOverlay(confirmSheet);
}


  
function openConfirm(){
  if (state.cart.length === 0) return;

  state.ui.backdropLocked = true; // üîí ‡∏•‡πá‡∏≠‡∏Å backdrop ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á confirm

  // ‚ùå ‡∏´‡πâ‡∏≤‡∏° close ‡∏î‡πâ‡∏ß‡∏¢ classList
  closeOverlay(cartSheet);

  renderConfirmSheet();

  // ‚ûï ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
  confirmSheet.innerHTML += `
    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="cancelConfirm()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(confirmSheet);
}

function cancelConfirm(){
  state.ui.backdropLocked = false;
  closeOverlay(confirmSheet);
  openOverlay(cartSheet);
}

function closeQty(){
  closeOverlay(qtySheet);
}

function openQtySheet(){
  // üîí GUARD: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ñ‡πâ‡∏≤ stock = 0
  if (!state.selectedProduct || Number(state.selectedProduct.stock) <= 0) {
    // ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: alert("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å");

    // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: toast error
    showToast("‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å", "error");
    return;
  }

  // üîí ‡∏õ‡∏¥‡∏î product sheet ‡∏ú‡πà‡∏≤‡∏ô overlay manager
  closeOverlay(productSheet);

  qtySheet.innerHTML = `
    <h3>‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</h3>

    <input type="number"
      min="1"
      max="${state.selectedProduct.stock}"
      value="1"
      oninput="state.qty = Number(this.value) || 1">

    <button class="btn btn-primary"
      style="width:100%;margin-top:12px"
      onclick="confirmAddToCart()">
      ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(qtySheet);

  // ‚úÖ Feedback ‡πÄ‡∏ä‡∏¥‡∏á info (optional ‡πÅ‡∏ï‡πà‡∏î‡∏µ‡∏°‡∏≤‡∏Å)
  showToast("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤", "info", 1500);

  // üéØ focus input ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  setTimeout(() => {
    const input = qtySheet.querySelector("input");
    if (input) {
      input.focus();
      focusInput(input);
    }
  }, 100);
}
  
function confirmAddToCart(){
  const p = state.selectedProduct;
  if (!p) return;

  const qty = Number(state.qty) || 1;

  // üîí GUARD: ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô stock
  const existing = state.cart.find(i => i.productId === p.productId);
  const currentQty = existing ? existing.qty : 0;

  if (currentQty + qty > Number(p.stock)) {
    // ‚ùå ‡πÄ‡∏î‡∏¥‡∏°: alert
    // alert(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ‡∏°‡∏µ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`);

    // ‚úÖ ‡πÉ‡∏´‡∏°‡πà: toast warning
    showToast(
      `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`,
      "warning"
    );
    return;
  }

  if(existing){
    existing.qty += qty;
  }else{
    state.cart.push({
      productId: p.productId,
      name: p.name,
      price: p.price,
      qty: qty
    });
  }

  renderBadge();

  // ‚úÖ Feedback ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á STEP 2Ô∏è‚É£)
  showToast(
    `‡πÄ‡∏û‡∏¥‡πà‡∏° "${p.name}" ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß`,
    "success"
  );

  resetToHome();
}
  
function resetToHome(){
  hardResetUI();
}

function hardResetUI({ refresh = false } = {}){
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  document.querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el);
    });

// üîì reset backdrop lock
state.ui.backdropLocked = false;

  // üîÑ reset state
  state.selectedProduct = null;
  state.qty = 1;

  // üîÑ optional refresh
  if (refresh) {
    renderProducts();
  }
}


function renderAdminLogin(){
  adminLoginSheet.innerHTML = `
    <h3>Admin Login</h3>

    <div class="form-group">
      <input id="adminUser"
        placeholder="Username"
        onfocus="focusInput(this)">
    </div>

    <div class="form-group">
      <input id="adminPass"
        type="password"
        placeholder="Password"
        onfocus="focusInput(this)">
    </div>

    <button class="btn btn-primary"
      id="adminLoginBtn"
      style="width:100%;margin-top:12px"
      onclick="handleAdminLogin(this)">
      Login
    </button>

    <button class="btn btn-outline"
      id="adminCancelBtn"
      style="width:100%;margin-top:8px"
      onclick="cancelAdminLogin()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏Å‡∏î backdrop ‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ
  state.ui.backdropLocked = false;

  openOverlay(adminLoginSheet);
}

async function handleAdminLogin(btn){
  // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if (state.isSubmitting) return;

  const userInput = document.getElementById("adminUser");
  const passInput = document.getElementById("adminPass");
  const cancelBtn = document.getElementById("adminCancelBtn");

  const username = userInput.value.trim();
  const password = passInput.value;

  if (!username || !password) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Username ‡πÅ‡∏•‡∏∞ Password");
    return;
  }

  // ================= UX START =================
  state.isSubmitting = true;

  if (btn) {
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
  }
  if (cancelBtn) cancelBtn.disabled = true;

  showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô...");
  // ================= UX END ===================

  try {
    // üîê CALL BACKEND LOGIN
    const form = new URLSearchParams();
    form.append("action", "adminLogin");
    form.append("username", username);
    form.append("password", password);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    });

    const json = await res.json();

    if (!json.success || !json.token) {
      throw new Error(json.error || json.message || "Login failed");
    }

    // ‚úÖ SAVE SESSION (STATE)
    state.admin.loggedIn = true;
    state.admin.user = json.username;
    state.admin.token = json.token;
    state.admin.expiredAt = json.expiredAt;

    // ‚úÖ SAVE SESSION (PERSIST)
    saveAdminSession(json);

    // üßπ CLOSE LOGIN SHEET
    closeOverlay(adminLoginSheet);

    // üîì reset lock ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡πâ‡∏≤‡∏á
    state.ui.backdropLocked = false;

    // üöÄ ENTER ADMIN MODE
    enterAdmin();

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ");

  } finally {
    // ================= CLEANUP =================
    safeHideLoading();
    state.isSubmitting = false;

    if (btn) {
      btn.disabled = false;
      btn.textContent = "Login";
    }
    if (cancelBtn) cancelBtn.disabled = false;
  }
}

async function openAdminDashboard(mode = "PENDING", force = false) {
  // ‚ùå ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ intent ‡∏à‡∏£‡∏¥‡∏á
  if (!force && !allowOpenOrders) return;

  // üîê session guard (‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î UI)
  if (
    !state.admin.loggedIn ||
    !state.admin.token ||
    isAdminSessionExpired()
  ) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
    exitAdmin();
    return;
  }

  // üîí ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏¥‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (‡∏Å‡∏±‡∏ô‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥)
  allowOpenOrders = false;

  // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Timeline
  closeOverlay(adminStockSheet);

  // üîç reset search
  state.search = "";

  // ‚úÖ Loading UI
  adminDashboardSheet.innerHTML = `
    <h3>${mode === "PENDING"
      ? "Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)"
      : "Order History"}</h3>

    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
  `;

  openOverlay(adminDashboardSheet);

  try {
    state.admin.orders = await fetchOrders();

    const orders = state.admin.orders.filter(o =>
      mode === "PENDING"
        ? o.status === "PENDING"
        : o.status !== "PENDING"
    );

    adminDashboardSheet.innerHTML = `
      <h3>${mode === "PENDING"
        ? "Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)"
        : "Order History"}</h3>

      ${
        orders.length
          ? orders.map(o => `
              <div class="card"
                onclick="openAdminOrder('${o.orderId}')">
                <div class="name">${o.orderId}</div>
                <div>Status: ${o.status}</div>
                <div>Total: ‡∏ø${Number(o.total).toLocaleString()}</div>
              </div>
            `).join("")
          : `
            <div style="color:#888;text-align:center;margin-top:24px">
              ${mode === "PENDING"
                ? "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
                : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"}
            </div>
          `
      }
    `;
  } catch (err) {
    console.error(err);

    // üî¥ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô session error ‚Üí ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if (
      err.message?.includes("Session") ||
      err.message?.includes("token")
    ) {
      alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
      exitAdmin();
      return;
    }

    adminDashboardSheet.innerHTML = `
      <h3>Orders</h3>

      <div style="text-align:center;color:#d93025;margin-top:32px">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ
      </div>

      <button class="btn btn-secondary"
        style="width:100%;margin-top:16px"
        onclick="handleOpenOrders()">
        üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
      </button>

      <button class="btn"
        style="width:100%;margin-top:8px"
        onclick="finishAdminAction({ refresh:false })">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>
    `;
  }
}


function handleOpenOrders() {
  allowOpenOrders = true;
  openAdminDashboard("PENDING", true);
}

async function openStockTimeline() {
  closeOverlay(adminDashboardSheet);

  adminStockSheet.innerHTML = `
    <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
    <div class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
  `;

  openOverlay(adminStockSheet);

  try {
    const logsRes = await fetchStockLogs();
    const logs = Array.isArray(logsRes?.data) ? logsRes.data : [];

    /* ================= GROUP ORDER OUT ================= */
    const orderMap = {};
    const singles = [];

    logs.forEach(l => {
  const time = l.timestamp ? new Date(l.timestamp) : new Date();

  // ‚úÖ ‡πÉ‡∏ä‡πâ orderId ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å sheet (fallback ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤)
  const orderRef = l.orderId || l.ref || null;

  if (l.type === "OUT" && orderRef) {
    if (!orderMap[orderRef]) {
      orderMap[orderRef] = {
        orderId: orderRef,
        time,
        by: l.by || "-",
        items: []
      };
    }

    orderMap[orderRef].items.push({
      productId: l.productId,
      qty: Math.abs(Number(l.qty || 0)),
      before: l.before,
      after: l.after
    });
  } else {
    singles.push({
      ...l,
      _time: time
    });
  }
});

    /* ================= BUILD TIMELINE ================= */
    const timeline = [];

    Object.values(orderMap).forEach(o => {
      timeline.push({
        kind: "ORDER",
        type: "OUT",
        orderId: o.orderId,
        time: o.time,
        by: o.by,
        items: o.items
      });
    });

    singles.forEach(l => {
      timeline.push({
        kind: "STOCK",
        type: l.type,
        productId: l.productId,
        qty: l.qty,
        before: l.before,
        after: l.after,
        time: l._time,
        by: l.by || "-"
      });
    });

    // üïí latest first (safe)
    timeline.sort((a, b) => b.time.getTime() - a.time.getTime());

    /* ================= RENDER ================= */
    adminStockSheet.innerHTML = `
      <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>

      <button class="btn btn-secondary"
        style="width:100%;margin-bottom:12px"
        onclick="finishAdminAction({ refresh:false })">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>

      ${
        timeline.length
          ? timeline.map(t => {

              if (t.kind === "ORDER") {
                return `
                  <div class="card">
                    <div class="timeline-tag tag-out">
                      üßæ ‡∏Ç‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ${t.orderId})
                    </div>

                    ${t.items.map(i => `
                      <div style="font-size:14px;line-height:1.5">
                        ${i.productId} x ${i.qty}
                        ${
                          Number.isFinite(i.before)
                            ? `<span style="color:#888">
                                (${i.before} ‚Üí ${i.after})
                              </span>`
                            : ""
                        }
                      </div>
                    `).join("")}

                    <div style="font-size:12px;color:#888;margin-top:6px">
                      ${t.time.toLocaleDateString("th-TH")}
                      ${t.time.toLocaleTimeString("th-TH")}
                      ¬∑ ‡πÇ‡∏î‡∏¢ ${t.by}
                    </div>
                  </div>
                `;
              }

              const typeMap = {
                IN:     { text: "‚ûï ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤", class: "tag-in" },
                CREATE: { text: "üÜï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", class: "tag-create" },
                ADJUST: { text: "‚úèÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å", class: "tag-adjust" }
              };

              const cfg = typeMap[t.type] || { text: t.type, class: "" };

              return `
                <div class="card">
                  <div class="timeline-tag ${cfg.class}">
                    ${cfg.text}
                  </div>

                  <div style="font-size:14px">
                    ${t.productId}
                    ${
                      Number.isFinite(t.before)
                        ? ` (${t.before} ‚Üí ${t.after})`
                        : ""
                    }
                  </div>

                  <div style="font-size:12px;color:#888;margin-top:6px">
                    ${t.time.toLocaleDateString("th-TH")}
                    ${t.time.toLocaleTimeString("th-TH")}
                    ¬∑ ‡πÇ‡∏î‡∏¢ ${t.by}
                  </div>
                </div>
              `;
            }).join("")
          : `
            <div style="text-align:center;color:#888;margin-top:32px">
              ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πä‡∏≠‡∏Å
            </div>
          `
      }
    `;

  } catch (err) {
    console.error(err);

    adminStockSheet.innerHTML = `
      <h3>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
      <div style="text-align:center;color:#d93025;margin-top:32px">
        ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ
      </div>
    `;
  }
}



function openAdminOrder(orderId){
  const order = state.admin.orders.find(o => o.orderId === orderId);
  if (!order) return;

  state.admin.selectedOrder = order;

  // ‚úÖ FIX: items ‡πÄ‡∏õ‡πá‡∏ô array ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á parse
  const items = Array.isArray(order.items)
    ? order.items
    : [];

  adminOrderSheet.innerHTML = `
    <h3>${order.orderId}</h3>

    ${items.map(i => `
      <div class="cart-item">
        <div>${i.name} x ${i.qty}</div>
        <div>‡∏ø${i.price * i.qty}</div>
      </div>
    `).join("")}

    <div class="total">Total: ‡∏ø${order.total}</div>

    <div class="admin-action">
      <button class="btn btn-approve" onclick="handleApprove()">
        Approve
      </button>

      <button class="btn btn-reject" onclick="handleReject()">
        Reject
      </button>
    </div>
  `;

  // ‚ùå ‡∏´‡πâ‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢ classList
  closeOverlay(adminDashboardSheet);

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
  openOverlay(adminOrderSheet);
}

async function handleApprove() {
  // üîí GUARD: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô admin mode ‡πÅ‡∏•‡∏∞‡∏°‡∏µ order
  if (state.mode !== "admin" || !state.admin.selectedOrder) return;

  try {
    const o = state.admin.selectedOrder;

    // ‚úÖ CORE: ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ loading + toast + guard)
    await adminApproveOrder(o.orderId);

    // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Order Detail ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminOrderSheet);

    // üîÑ refresh stock + product list
    await refreshProducts();

    // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î Orders (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ flow ‡∏ô‡∏µ‡πâ)
    allowOpenOrders = true;

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
    await openAdminDashboard("PENDING", true);

  } catch (err) {
    // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡∏ã‡πâ‡∏≥
    // toast + error handling ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô adminApproveOrder ‡πÅ‡∏•‡πâ‡∏ß
    console.warn("handleApprove aborted:", err);
  }
}

async function handleReject() {
  // üîí GUARD: ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô admin mode ‡πÅ‡∏•‡∏∞‡∏°‡∏µ order
  if (state.mode !== "admin" || !state.admin.selectedOrder) return;

  try {
    const o = state.admin.selectedOrder;

    // ‚úÖ CORE: ‡πÉ‡∏ä‡πâ API ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏°‡∏µ loading + toast + guard)
    await adminRejectOrder(o.orderId);

    // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ Order Detail ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminOrderSheet);

    // üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÅ‡∏°‡πâ reject ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î stock ‡πÅ‡∏ï‡πà UI ‡∏ï‡πâ‡∏≠‡∏á sync)
    await refreshProducts();

    // ‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î Orders (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ flow ‡∏ô‡∏µ‡πâ)
    allowOpenOrders = true;

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Orders (‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£)
    await openAdminDashboard("PENDING", true);

  } catch (err) {
    // ‚ùå ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á alert ‡∏ã‡πâ‡∏≥
    // toast + error handling ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ô adminRejectOrder ‡πÅ‡∏•‡πâ‡∏ß
    console.warn("handleReject aborted:", err);
  }
}

async function submitStockIn(){
  // üîí guard
  if (state.mode !== "admin" || !state.selectedProduct) {
    alert("Unauthorized");
    return;
  }

  const qtyInput    = document.getElementById("stockQty");
  const reasonInput = document.getElementById("stockReason");

  const qty    = Number(qtyInput.value);
  const reason = reasonInput.value.trim();

  // üîç validate
  if (!Number.isInteger(qty) || qty <= 0) {
    alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    qtyInput.focus();
    return;
  }

  // üîí disable ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  const buttons = adminStockActionSheet.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);

  try {
    const res = await adminStockIn(
      state.selectedProduct.productId,
      qty,
      reason
    );

    if (res.error) {
      throw new Error(res.error);
    }

    alert("‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");

    // üîÑ refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    await refreshProducts();

    // üßπ reset input
    qtyInput.value = "";
    reasonInput.value = "";

    // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Action ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminStockActionSheet);

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏°‡πà‡∏Ç‡∏≠‡∏á admin ‡πÅ‡∏ö‡∏ö‡∏ô‡∏¥‡πà‡∏á
    finishAdminAction({ refresh: true });

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
  } finally {
    // üîì ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    buttons.forEach(b => b.disabled = false);
  }
}


async function submitStockAdjust(){
  // üîí guard
  if (state.mode !== "admin" || !state.selectedProduct) {
    alert("Unauthorized");
    return;
  }

  const qtyInput    = document.getElementById("stockQty");
  const reasonInput = document.getElementById("stockReason");

  const newQty = Number(qtyInput.value);
  const reason = reasonInput.value.trim();

  // üîç validate
  if (!Number.isInteger(newQty) || newQty < 0) {
    alert("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    qtyInput.focus();
    return;
  }

  // üîí disable ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  const buttons = adminStockActionSheet.querySelectorAll("button");
  buttons.forEach(b => b.disabled = true);

  try {
    const res = await adminStockAdjust(
      state.selectedProduct.productId,
      newQty,
      reason
    );

    if (res.error) {
      throw new Error(res.error);
    }

    alert("‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß");

    // üîÑ refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    await refreshProducts();

    // üßπ reset input
    qtyInput.value = "";
    reasonInput.value = "";

    // ‚úÖ ‡∏õ‡∏¥‡∏î Stock Action ‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
    closeOverlay(adminStockActionSheet);

    // ‚úÖ ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (flow ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
    openAdminProductAction(state.selectedProduct);

  } catch (err) {
    console.error(err);
    alert(err.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏î‡πâ");
  } finally {
    // üîì ‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ
    buttons.forEach(b => b.disabled = false);
  }
}
  
function openStockAction(p){
  // üîí guard
  if (state.mode !== "admin") return;

  state.selectedProduct = p;

  adminStockActionSheet.innerHTML = `
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>
    <div>${p.name}</div>
    <div>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${p.stock}</div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input id="stockQty" type="number" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10">
    </div>

    <div class="form-group">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input id="stockReason" placeholder="‡∏ñ‡πâ‡∏≤‡∏°‡∏µ">
    </div>

    <button class="btn btn-secondary"
      onclick="submitStockIn()">
      ‚ûï ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ (IN)
    </button>

    <button class="btn btn-primary"
      style="margin-top:8px"
      onclick="submitStockAdjust()">
      ‚úèÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡∏¢‡∏≠‡∏î
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(adminStockActionSheet);
}

async function refreshProductsWithFeedback({
  loadingText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...",
  successText = "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢",
  silent = false
} = {}) {
  try {
    // 1Ô∏è‚É£ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (UX ‡∏•‡∏∑‡πà‡∏ô)
    if (Array.isArray(state.products) && state.products.length) {
      renderProducts();
    }

    // 2Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ)
    if (!silent) {
      showToast(loadingText, "info", 1200);
    }

    // 3Ô∏è‚É£ ‡πÉ‡∏ä‡πâ CORE function (single source of truth)
    await refreshProducts();

    // 4Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    if (!silent) {
      showToast(successText, "success", 1000);
    }

  } catch (err) {
    console.error(err);

    // 5Ô∏è‚É£ ‡πÅ‡∏à‡πâ‡∏á error ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á UI
    if (!silent) {
      showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ", "error");
    }
  }
}
 
function openAdminMenu(){
  if (
    !state.admin.loggedIn ||
    !state.admin.token ||
    isAdminSessionExpired()
  ) {
    alert("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà");
    exitAdmin();
    return;
  }
  
  adminMenuSheet.innerHTML = `
    <h3>Admin Menu</h3>

    <!-- üîπ MAIN ACTIONS -->
    <div class="menu-group">
      <button class="btn btn-primary"
        onclick="closeAdminMenu(); handleOpenOrders();">
        üì¶ Orders
      </button>

      <button class="btn btn-secondary"
        onclick="closeAdminMenu(); openStockTimeline();">
        üì¶ Stock Timeline
      </button>

      <button class="btn btn-secondary"
        onclick="closeAdminMenu(); openAddProduct();">
        ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
      </button>
    </div>

    <hr>

    <!-- üîª DANGER ZONE -->
    <div class="menu-group danger">
      <button class="btn btn-danger"
        onclick="exitAdmin();">
        üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô
      </button>
    </div>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(adminMenuSheet);
}


function openAddProduct(){
  state.addImageFile = null;

  adminAddProductSheet.innerHTML = `
    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>

    <div style="font-size:13px;color:#666;margin-bottom:12px">
      ‚ÑπÔ∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Stock Timeline
    </div>

    <div class="form-group">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</label>
      <input id="addProductId" placeholder="‡πÄ‡∏ä‡πà‡∏ô P002">
    </div>

    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">
    </div>

    <div class="form-group">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
      <input id="addPrice" type="number" placeholder="0">
    </div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô)</label>
      <input id="addStock" type="number" placeholder="0">
    </div>

    <div class="form-group">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select id="addActive">
        <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</option>
        <option value="false">‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</option>
      </select>
    </div>

    <div class="form-group">
      <label>‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <img id="addImagePreview"
        style="width:100%;border-radius:12px;display:none;margin-bottom:6px">
      <input type="file"
        accept="image/*"
        onchange="handleAddImagePreview(this)">
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="submitAddProduct(this)">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    </button>

    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="closeAddProduct()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  openOverlay(adminAddProductSheet);
}



function handleAddImagePreview(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    const img = document.getElementById("addImagePreview");
    img.src = reader.result;
    img.style.display = "block";

    state.addImageFile = file; // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ upload
  };
  reader.readAsDataURL(file);
}

function closeAddProduct(){
  state.addImageFile = null;
  closeOverlay(adminAddProductSheet);
}
  
function closeAdminMenu(){
  closeOverlay(adminMenuSheet);
}
   
/* ================= VIEWER FLOW ================= */
function openProduct(p){
  // üî¥ ADMIN FLOW
  // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‚Üí ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î product sheet ‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  if (state.mode === "admin") {
    openAdminProductAction(p);
    return;
  }

  // üü¢ VIEWER FLOW
  state.selectedProduct = p;
  state.qty = 1;

  renderProductSheet();

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(productSheet);
}

// üî¥ NEW: cancel admin login
function cancelAdminLogin(){
  closeOverlay(adminLoginSheet);
}
  
function closeProduct(){
  closeOverlay(productSheet);
}

async function submitOrder(){
  if (state.isSubmitting || state.cart.length === 0) return;

  state.isSubmitting = true;
  state.ui.backdropLocked = true;
  renderConfirmSheet();

  let timeoutHit = false;

  // ‚õëÔ∏è TIMEOUT SAFETY
  const timeoutId = setTimeout(() => {
    timeoutHit = true;
    console.warn('[submitOrder] timeout');

    showToast("‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà", "warning");

    // ‚ùó ‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å hideLoading ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ‡πÉ‡∏´‡πâ flow ‡∏´‡∏•‡∏±‡∏Å‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ cleanup ‡∏ó‡∏µ‡πà finally ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  }, 15000);

  try {
    // ================= STEP 1: CHECK STOCK =================
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å...');
    const stockCheck = await checkStockBeforeSubmit();

    if (timeoutHit) throw new Error("Request timeout");

    if (!stockCheck.ok) {
      showToast(stockCheck.message, 'warning');
      return;
    }

    // ================= STEP 2: CREATE ORDER =================
    showLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠...');
    const res = await createOrder();

    if (timeoutHit) throw new Error("Request timeout");

    if (!res || res.success !== true || !res.data?.orderId) {
      throw new Error("Invalid order response");
    }

    // ================= SUCCESS =================
    state.lastOrder = {
      orderId: res.data.orderId,
      items: JSON.parse(JSON.stringify(state.cart)),
      total: state.cart.reduce((s,i)=>s+i.price*i.qty,0),
      createdAt: new Date()
    };

    exportOrderPNG();
    showToast('‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');

    state.cart = [];
    renderBadge();

    setTimeout(() => {
      hardResetUI();
    }, 300);

  } catch(err){
    console.error(err);

    // ‚ùó timeout ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ toast
    if (!timeoutHit) {
      showToast(
        err.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠',
        'error'
      );
    }

  } finally {
    // ================= SINGLE CLEANUP POINT =================
    clearTimeout(timeoutId);

    safeHideLoading();
    state.isSubmitting = false;
    state.ui.backdropLocked = false;
  }
}


function openCart(){
  renderCart();

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  openOverlay(cartSheet);
}

function closeCart(){
  closeOverlay(cartSheet);
}

function removeItem(idx){
  state.cart.splice(idx,1);
  renderBadge();

  // üîî Feedback: ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ß‡πà‡∏≤‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß
  showToast("‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß", "warning");

  if(state.cart.length === 0){
    hardResetUI();   // ‚úÖ ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å sheet + backdrop
  } else {
    renderCart();
  }
}

function openProductEdit(p){
  state.selectedProduct = p;

  adminProductEditSheet.innerHTML = `
    <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <div class="form-group">
      <label>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)</label>
      <input value="${p.productId}" disabled>
    </div>

    <div class="form-group">
      <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <input id="editName" value="${p.name}">
    </div>

    <div class="form-group">
      <label>‡∏£‡∏≤‡∏Ñ‡∏≤</label>
      <input id="editPrice" type="number" value="${p.price}">
    </div>

    <div class="form-group">
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label>
      <input id="editStock" type="number" value="${p.stock}">
    </div>

    <div class="form-group">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select id="editActive">
        <option value="true" ${p.active ? "selected" : ""}>‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</option>
        <option value="false" ${!p.active ? "selected" : ""}>‡∏õ‡∏¥‡∏î‡∏Ç‡∏≤‡∏¢</option>
      </select>
    </div>

    <div class="form-group">
      <label>‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
      <img id="imagePreview"
        src="${p.image || ""}"
        style="width:100%;border-radius:12px;margin-bottom:6px">
      <input type="file"
        accept="image/*"
        onchange="handleImagePreview(this)">
    </div>

    <button class="btn btn-primary"
      style="width:100%;margin-top:16px"
      onclick="submitProductEdit()">
      ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    </button>

    <button class="btn btn-secondary"
      style="width:100%;margin-top:8px"
      onclick="closeProductEdit()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  openOverlay(adminProductEditSheet); // ‚úÖ ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠
}

function handleImagePreview(input){
  const file = input.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    document.getElementById("imagePreview").src = reader.result;

    // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏ß‡πâ‡∏£‡∏≠ STEP 7.5.2
    state.editImageFile = file;
  };
  reader.readAsDataURL(file);
}

function closeProductEdit(){
  state.editImageFile = null;
  closeOverlay(adminProductEditSheet);
}

async function uploadProductImage(file) {
  return new Promise((resolve, reject) => {
    // üîí guard token
    if (!state.admin || !state.admin.token) {
      reject("Missing admin token");
      return;
    }

    const reader = new FileReader();

    reader.onload = async () => {
      try {
        // üîπ ‡∏ï‡∏±‡∏î data:image/...;base64,
        const base64 = reader.result.split(",")[1];

        // ‚úÖ ‡πÉ‡∏ä‡πâ FormData
        const formData = new FormData();
        formData.append("action", "uploadProductImage"); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏≠‡∏¢‡∏π‡πà)
        formData.append("token", state.admin.token);
        formData.append("filename", file.name);
        formData.append("mimeType", file.type || "image/jpeg");
        formData.append("data", base64);

        const res = await fetch(API_URL, {
          method: "POST",
          body: formData
        });

        const json = await res.json();

        // üîí backend wrap data ‡πÑ‡∏ß‡πâ‡πÉ‡∏ô data
        if (!json.success || !json.data || !json.data.imageUrl) {
          reject(json.error || json.message || "Upload failed");
          return;
        }

        // ‚úÖ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        resolve(json.data.imageUrl);

      } catch (err) {
        reject(err);
      }
    };

    reader.onerror = () => {
      reject("File read error");
    };

    reader.readAsDataURL(file);
  });
}
  
async function submitProductEdit(){
  const p = state.selectedProduct;
  if(!p) return;

  const name   = document.getElementById("editName").value.trim();
  const price  = Number(document.getElementById("editPrice").value);
  const stock  = Number(document.getElementById("editStock").value);
  const active = document.getElementById("editActive").value === "true";

  // üîí Validate
  if(!name || price < 0 || stock < 0){
    alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    return;
  }

  let imageUrl = p.image || "";

  try {
    // ================= STEP 7.5.3 =================
    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà ‚Üí upload ‡∏Å‡πà‡∏≠‡∏ô
    if(state.editImageFile){
      imageUrl = await uploadProductImage(state.editImageFile);
      if(!imageUrl){
        throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏î‡πâ");
      }
    }

    // ================= STEP 7.5.4 =================
    // Update product data
    const form = new URLSearchParams();
    form.append("action", "updateProduct"); // ‚úÖ FIX: ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏° backend
    form.append("token", state.admin.token); // ‚úÖ FIX: AUTH REQUIRED
    form.append("productId", p.productId);
    form.append("name", name);
    form.append("price", price);
    form.append("stock", stock);
    form.append("active", active);
    form.append("image", imageUrl);
    
    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    }).then(r => r.json());

    if (res.error || res.success === false) {
      throw new Error(res.message || res.error || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");

    // cleanup
    state.editImageFile = null;
    closeProductEdit();
    await refreshProducts();

  } catch(err){
    console.error(err);
    alert(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
  }
}
  
async function submitAddProduct(btn){
  // üîí guard
  if(state.mode !== "admin" || !state.admin.loggedIn){
    alert("Unauthorized");
    return;
  }

  // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
  if(state.isSubmitting) return;
  state.isSubmitting = true;

  // ‚úÖ ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å parameter
  if(btn){
    btn.disabled = true;
    btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
  }

  try {
    const productId = document.getElementById("addProductId").value.trim();
    const name      = document.getElementById("addName").value.trim();
    const price     = Number(document.getElementById("addPrice").value);
    const stock     = Number(document.getElementById("addStock").value);
    const active    = document.getElementById("addActive").value === "true";

    /* ================= VALIDATE ================= */

    if (!productId) {
      document.getElementById("addProductId").focus();
      throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU)");
    }

    if (!name) {
      document.getElementById("addName").focus();
      throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
    }

    if (!Number.isInteger(price) || !Number.isInteger(stock)) {
      throw new Error("‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ï‡πá‡∏°");
    }

    if (price < 0 || stock < 0) {
      throw new Error("‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö 0");
    }

    const dup = state.products.find(p => p.productId === productId);
    if (dup) {
      document.getElementById("addProductId").focus();
      throw new Error("‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (SKU) ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
    }

    /* ================= IMAGE UPLOAD ================= */

    let imageUrl = "";
    if (state.addImageFile) {
      imageUrl = await uploadProductImage(state.addImageFile);
      if (!imageUrl) {
        throw new Error("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }

    /* ================= SEND TO BACKEND ================= */

    const form = new URLSearchParams();
    form.append("action", "addProduct"); // ‚úÖ FIX ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤
    form.append("token", state.admin.token);
    form.append("productId", productId);
    form.append("name", name);
    form.append("price", price);
    form.append("stock", stock);
    form.append("active", active);
    form.append("image", imageUrl);

    const res = await fetch(API_URL, {
      method: "POST",
      body: form
    }).then(r => r.json());

    if(res.error || res.success === false){
      throw new Error(res.message || res.error || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    }

    alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ üéâ");

    // üßπ cleanup
    state.addImageFile = null;
    closeAddProduct();
    await refreshProducts();

  } catch(err){
    console.error(err);
    alert(err.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  } finally {
    state.isSubmitting = false;

    if(btn){
      btn.disabled = false;
      btn.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤";
    }
  }
}

function openAdminProductAction(p){
  // üîí guard
  if (state.mode !== "admin") return;

  state.selectedProduct = p;

  adminProductActionSheet.innerHTML = `
    <h3>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>

    <div style="
      font-weight:600;
      font-size:16px;
      margin-bottom:4px
    ">
      ${p.name}
    </div>

    <div style="
      font-size:12px;
      color:#888;
      margin-bottom:16px
    ">
      ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.productId}
    </div>

    <!-- ‚úèÔ∏è EDIT PRODUCT -->
    <button class="btn btn-primary"
      style="width:100%;margin-bottom:10px"
      onclick="
        closeAdminProductAction();
        openProductEdit(state.selectedProduct);
      ">
      ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    </button>

    <!-- üì¶ STOCK -->
    <button class="btn btn-secondary"
      style="width:100%;margin-bottom:16px"
      onclick="
        closeAdminProductAction();
        openStockAction(state.selectedProduct);
      ">
      üì¶ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å
    </button>

    <!-- ‚ùå CANCEL -->
    <button class="btn btn-outline"
      onclick="closeAdminProductAction()">
      ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
    </button>
  `;

  // ‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Overlay Manager
  openOverlay(adminProductActionSheet);
}

function closeAdminProductAction(){
  closeOverlay(adminProductActionSheet);
}

function isAdminSessionExpired(expiredAt = state.admin.expiredAt) {
  // ‚ùó ‡πÑ‡∏°‡πà‡∏°‡∏µ expiredAt = session invalid ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  if (!expiredAt) return true;

  return Date.now() > new Date(expiredAt).getTime();
}  

/* ================= EXPORT ORDER PNG (FINAL) ================= */
function exportOrderPNG(type = "A4") {
  const order = state.lastOrder;
  if (!order) return;

  /* ================= PRESET ================= */
  const PRESET = {
    A4: {
      width: 794,
      padding: 48,
      titleSize: 28,
      textSize: 16,
      lineHeight: 32
    },
    THERMAL_80: {
      width: 384,
      padding: 16,
      titleSize: 20,
      textSize: 13,
      lineHeight: 24
    },
    THERMAL_58: {
      width: 280,
      padding: 14,
      titleSize: 18,
      textSize: 12,
      lineHeight: 22
    }
  };

const cfg = PRESET[type];
if (!cfg) throw new Error("Unknown receipt type");

/* ================= CANVAS SIZE ================= */
const headerLines = 6;
const itemLines = order.items.length * 2;
const footerLines = 4;

const height =
  cfg.padding * 2 +
  (headerLines + itemLines + footerLines) * cfg.lineHeight;

const canvas = document.createElement("canvas");
canvas.width = cfg.width;
canvas.height = height;

const ctx = canvas.getContext("2d");

/* ================= BACKGROUND ================= */
ctx.fillStyle = "#f2f2f7";
ctx.fillRect(0, 0, canvas.width, canvas.height);

/* ================= CARD ================= */
ctx.fillStyle = "#ffffff";
ctx.shadowColor = "rgba(0,0,0,0.08)";
ctx.shadowBlur = 20;
ctx.shadowOffsetY = 6;

ctx.beginPath();

if (typeof ctx.roundRect === "function") {
  // ‚úÖ Modern browsers
  ctx.roundRect(8, 8, canvas.width - 16, canvas.height - 16, 18);
} else {
  // üîÅ Fallback for old Safari / WebView
  const x = 8;
  const y = 8;
  const w = canvas.width - 16;
  const h = canvas.height - 16;
  const r = 18;

  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
}

ctx.fill();
ctx.shadowColor = "transparent";

/* ================= TEXT ================= */
let y = cfg.padding + cfg.lineHeight;
ctx.fillStyle = "#000";

/* ===== TITLE ===== */
ctx.font = `700 ${cfg.titleSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
ctx.fillText("‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", cfg.padding, y);
y += cfg.lineHeight + 8;

/* ===== META ===== */
ctx.font = `${cfg.textSize}px -apple-system, BlinkMacSystemFont, sans-serif`;
ctx.fillText(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${order.orderId}`, cfg.padding, y);
y += cfg.lineHeight;

ctx.fillText(
  `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${order.createdAt.toLocaleString()}`,
  cfg.padding,
  y
);
y += cfg.lineHeight;

/* ===== DIVIDER ===== */
ctx.strokeStyle = "#dddddd";
ctx.beginPath();
ctx.moveTo(cfg.padding, y);
ctx.lineTo(canvas.width - cfg.padding, y);
ctx.stroke();
y += cfg.lineHeight;

  /* ================= ITEMS (2 LINES / SAFE WRAP) ================= */
  ctx.font = `${cfg.textSize}px -apple-system, BlinkMacSystemFont, sans-serif`;

  order.items.forEach(i => {
    const nameText = `[${i.productId}] ${i.name}`;
    const qtyText = `x ${i.qty}`;
    const priceText = `‡∏ø${(i.price * i.qty).toLocaleString()}`;

    const maxNameWidth = canvas.width - cfg.padding * 2;
    const priceWidth = ctx.measureText(priceText).width;

    // --- Line 1: SKU + NAME (wrap) ---
    let line = "";
    for (const ch of nameText) {
      const test = line + ch;
      if (ctx.measureText(test).width > maxNameWidth) {
        ctx.fillText(line, cfg.padding, y);
        y += cfg.lineHeight;
        line = ch;
      } else {
        line = test;
      }
    }
    ctx.fillText(line, cfg.padding, y);
    y += cfg.lineHeight;

    // --- Line 2: QTY (left) + PRICE (right) ---
    ctx.fillText(qtyText, cfg.padding, y);
    ctx.fillText(
      priceText,
      canvas.width - cfg.padding - priceWidth,
      y
    );

    y += cfg.lineHeight;
  });

  /* ===== DIVIDER ===== */
  y += 4;
  ctx.strokeStyle = "#dddddd";
  ctx.beginPath();
  ctx.moveTo(cfg.padding, y);
  ctx.lineTo(canvas.width - cfg.padding, y);
  ctx.stroke();
  y += cfg.lineHeight;

  /* ================= TOTAL ================= */
  ctx.font = `700 ${cfg.textSize + 4}px -apple-system, BlinkMacSystemFont, sans-serif`;
  const totalText = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${order.total.toLocaleString()}`;
  const tw = ctx.measureText(totalText).width;
  ctx.fillText(
    totalText,
    canvas.width - cfg.padding - tw,
    y
  );

  /* ================= DOWNLOAD ================= */
  const a = document.createElement("a");
  a.download = `order-${order.orderId}-${type}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
}

function finishAdminAction({ refresh = true } = {}) {
  // üîí ‡∏õ‡∏¥‡∏î‡∏ó‡∏∏‡∏Å overlay ‡∏ú‡πà‡∏≤‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á (Overlay Manager)
  document.querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => {
      closeOverlay(el); // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à
    });

  // ‚ùå ‡∏Å‡∏±‡∏ô Orders ‡πÄ‡∏î‡πâ‡∏á‡∏ã‡πâ‡∏≥
  allowOpenOrders = false;

  // üîç RESET SEARCH (‡∏Å‡∏±‡∏ô filter ‡∏Ñ‡πâ‡∏≤‡∏á)
  state.search = "";

  // üîÑ optional refresh ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (refresh) {
    refreshProducts();
  }

  // üîÑ render header ‡πÉ‡∏´‡∏°‡πà (search ‡∏à‡∏∞‡πÇ‡∏•‡πà‡∏á)
  renderHeader();
}

/* ================= GLOBAL INPUT FOCUS FIX ================= */
function focusInput(el) {
  if (!el) return;

  setTimeout(() => {
    try {
      el.scrollIntoView({
        behavior: "smooth",
        block: "center"
      });
    } catch (e) {
      el.scrollIntoView();
    }
  }, 200);
}

function saveAdminSession({ token, username, expiredAt }) {
  localStorage.setItem("admin_session", JSON.stringify({
    token,
    username,
    expiredAt
  }));
}

function loadAdminSession() {
  try {
    return JSON.parse(localStorage.getItem("admin_session"));
  } catch {
    return null;
  }
}

function clearAdminSession() {
  localStorage.removeItem("admin_session");
}

function safeHideLoading() {
  try {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) overlay.classList.add("hidden");

    state.isSubmitting = false;
    state.ui.backdropLocked = false;

    if (state.ui.overlayCount === 0 && backdrop) {
      backdrop.style.display = "none";
    }

    console.log("[safeHideLoading] loading closed");
  } catch (e) {
    console.error("[safeHideLoading] failed", e);
  }
}

// ================= EMERGENCY UI UNLOCK =================
// ‚ö†Ô∏è DEV / ADMIN USE ONLY
window.forceUnlockUI = function(){
  console.warn('[forceUnlockUI] manual reset');

  // reset flags
  state.isSubmitting = false;
  state.ui.backdropLocked = false;
  state.ui.overlayCount = 0;

  // close all overlays
  document
    .querySelectorAll(".sheet.show, .side-menu.show")
    .forEach(el => el.classList.remove("show"));

  // hide loading overlay
  const overlay = document.getElementById("loading-overlay");
  if (overlay) overlay.classList.add("hidden");

  // hide backdrop
  if (backdrop) backdrop.style.display = "none";

  showToast("‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢", "info");
};

async function restoreAdminSessionIfValid() {
  const restored = loadAdminSession();
  if (!restored?.token || !restored?.expiredAt) return false;

  if (Date.now() > new Date(restored.expiredAt).getTime()) {
    clearAdminSession();
    return false;
  }

  try {
    // lightweight validate
    const res = await fetch(
      `${API_URL}?action=orders&token=${restored.token}`
    );
    const json = await res.json();

    if (json?.success === true) {
      state.admin.loggedIn = true;
      state.admin.user = restored.username;
      state.admin.token = restored.token;
      state.admin.expiredAt = restored.expiredAt;
      state.mode = "admin";
      return true;
    }
  } catch (e) {
    console.warn("restore admin failed");
  }

  clearAdminSession();
  return false;
}
  
/* ================= INIT APP (CLEAN / SAFE) ================= */
(async () => {
  try {
    state.search = "";

    const restored = loadAdminSession();
    let adminRestored = false;

    if (
      restored &&
      restored.token &&
      restored.expiredAt &&
      Date.now() < new Date(restored.expiredAt).getTime()
    ) {
      try {
        // ‚úÖ FIX: ‡πÉ‡∏ä‡πâ POST ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á backend
        const form = new URLSearchParams();
        form.append("action", "orders");
        form.append("token", restored.token);

        const res = await fetch(API_URL, {
          method: "POST",
          body: form
        });

        const json = await res.json();

        if (json && json.success === true) {
          state.admin.loggedIn = true;
          state.admin.user = restored.username;
          state.admin.token = restored.token;
          state.admin.expiredAt = restored.expiredAt;

          state.mode = "admin";
          adminRestored = true;
        }
      } catch (err) {
        console.warn("Admin session validation failed", err);
      }
    }

    // ‚ùå invalid / expired
    if (!adminRestored) {
      clearAdminSession();
      state.mode = "viewer";
    }

    // ‚úÖ ‡∏Ñ‡πà‡∏≠‡∏¢‡πÇ‡∏´‡∏•‡∏î data ‡∏´‡∏•‡∏±‡∏á‡∏£‡∏π‡πâ mode ‡πÅ‡∏•‡πâ‡∏ß
    await refreshProducts();

    renderHeader();
    renderProducts();
    renderBadge?.();

  } catch (err) {
    console.error("[INIT ERROR]", err);
    showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÑ‡∏î‡πâ", "error");
  } finally {
    safeHideLoading();
  }
})();
  
</script>
  
<!-- Toast Container -->
<div id="toast-container"></div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden">
  <div class="loading-box">
    <div class="spinner"></div>
    <div id="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...</div>
  </div>
</div>

  
</body>
</html>
